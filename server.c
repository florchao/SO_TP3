// Server side C/C++ program to demonstrate Socket programming
// https://www.geeksforgeeks.org/socket-programming-cc/ idea sacada de aca

#include <unistd.h>
#include <stdio.h>
#include <sys/socket.h>
#include <stdlib.h>
#include <netinet/in.h>
#include <string.h>
#define MAX_DESAFIOS 13
#define BUFF_SIZE 512
#define FIRST_ASCII 33
#define LAST_ASCII 127
char *pistas[MAX_DESAFIOS] = {"Bienvenidos al TP3 y felicitaciones, ya resolvieron el primer acertijo.\nEn este TP deberán finalizar el juego que ya comenzaron resolviendo los desafíos de cada nivel.\nAdemás tendrán que investigar otras preguntas para responder durante la defensa.\nEl desafío final consiste en crear un programa que se comporte igual que yo, es decir, que provea los mismos desafíos y que sea necesario hacer lo mismo para resolverlos. No basta con esperar la respuesta.\nAdemás, deberán implementar otro programa para comunicarse conmigo.\nDeberán estar atentos a los easter eggs.\nPara verificar que sus respuestas tienen el formato correcto respondan a este desafío con la palabra 'entendido\n'\n",
                              "The Wire S1E5 5295 888 6288\n",
                              "https://ibb.co/tc0Hb6w\n",
                              "EBADF… write: Bad File Descriptor\n",
                              " respuesta = strings:277\n",
                              ".data .bss .comment ? .shstrtab .symtab .strtab\n",
                              "Filter error\nL7a.\t->E*4Q{XZuY[A2!Oqf:^ 0aAF>rRes.mp:_zAOLu+vlq*t7e\"/ACsd*L$.ta]I>?? KpX$e$B~$?syK fv\\O: K0<^In5x>nyd<O8\"2UijMmFYm|R!fsC{p{'p/Ua}tkrj6gkD>KdM.CL&+FM1qUY-1|y0j@A41ja2NV1\n",
                              "¿?\n",
                              " Latexme\nSi\n\\mathrm{d}y = u^v{\\cdot}(v'{\\cdot}\\ln{(u)}+v{\\cdot}\frac{u'}{u})\nentonces\ny =\n",
                              "quine\ngcc: error: quine.c: No such file or directory\ngcc: fatal error: no input files\ncompilation terminated. ENTER para reintentar\n",
                              " quine. ¡Genial!, ya lograron meter un programa en quine.c, veamos si hace lo que corresponde. La respuesta es chin_chu_lan_cha\n",
                              " b gdbme y encontrá el valor mágico\n",
                              "Me conoces -0.369791 0.551903 -1.436070 -1.584591 -0.078987 -0.427328 1.554547 -0.145120 -0.728608 -0.041901 0.747826 0.466695 1.289457 2.091061 -0.824342 0.259702 -0.106045 0.613035 1.474037 -0.884951 -1.442406 -0.329313 -0.299472 -0.594775 0.089593 -0.330099 -0.124104 0.813127 -0.154575 0.645125 1.977811 1.366372 0.434051 0.468722 -0.348875 -0.313515 -0.067097 -0.325909 0.196640 -2.400979 1.322647 -2.530777 -0.354054 -0.379183 -0.391890 -1.125587 -0.800599 -1.326961 -0.146066 -0.564790 0.073536 -0.520760 -2.480873 -2.022180 0.727092 1.366611 0.920533 0.388097 0.241222 -0.142388 -0.347977 -0.549332 0.760219 -2.367225 -1.200645 0.241122 -1.725360 -0.040915 0.184444 -0.239627 0.329913 0.658787 -1.513845 0.554324 0.992836 -1.477832 0.721693 0.041277 1.174223 0.117992 0.517212 0.059082 0.153277 -2.018073 0.797023 -1.347940 0.329951 0.661368 -1.127084 1.575622 -1.333378 1.088792 -0.696617 0.735523 0.761118 -0.193826 -0.968073 1.501681 1.031919 1.091832 -0.065012 0.847388 -0.112720 -0.959477 -0.125563 0.899934 0.651228 -1.880491 0.740687 -0.404063 0.303663 0.653394 -0.419143 0.993517 -0.736323 0.195678 1.655301 0.785276 0.486564 1.362723 0.236576 1.448138 0.169960 -0.396617 -0.701931 1.024883 0.289069 -1.680868 0.342188 -0.602176 0.882933 0.789879 2.623815 0.021794 -0.006971 1.654224 -0.653455 -0.044442 0.927326 -2.189692 -0.481436 -0.749473 0.040486 -1.276691 0.416718 -1.713142 -2.260666 1.259803 -0.130525 -1.527880 -1.135303 -1.252988 0.081158 -0.491061 -0.576484 0.304903 -0.367471 -0.088555 1.566209 0.640124 -0.331284 0.811067 1.630045 0.033191 -0.943865 1.344680 -0.230471 -0.596889 -0.071315 0.010995 1.709981 1.368415 0.933640 -0.580064 2.045627 0.650437 -0.959672 -0.035811 0.869034 1.175639 -0.024787 -0.185995 -0.718142 -0.069375 2.260697 0.831881 0.584695 0.724348 0.452502 0.271728 -0.395184 -1.752259 0.389538 0.341332 -0.312266 -0.089107 -0.500606 1.895775 2.624930 1.449354 0.008339 0.858791 -0.130773 1.390426 1.434993 2.398802 0.242694 -0.891767 -1.080408 -0.204301 0.421682 0.205634 -0.483634 0.777767 0.836161 -2.966196 0.228231 -1.265352 -0.952480 -1.562586 -0.298999 -0.116298 0.547341 1.271506 0.392038 -0.117547 2.513847 0.913658 0.461773 0.367419 0.998126 -0.069793 2.486741 -1.894919 -1.125118 -0.639102 -0.830395 0.368424 0.611833 0.105381 0.261978 -0.867416 0.442681 -1.141283 -0.853025 0.133810 -1.340228 0.129749 0.905005 0.658655 -0.035836 -0.077644 1.603385 -1.012992 -0.449932 -1.415043 0.762397 -0.688332 -0.458636 0.622554 -0.371178 1.508505 0.173726 -0.509633 1.369777 1.328947 0.166344 1.818220 -0.496375 -0.526475 1.360255 -1.563396 0.055910 -0.397923 -0.077873 0.198359 0.688983 0.451443 2.307969 -0.706309 -2.189401 -0.342897 -0.894663 0.381149 0.097869 0.253679 2.252077 0.275119 -0.680324 1.179264 1.307461 -0.336388 -0.109528 0.240984 0.393777 1.379629 -0.492865 0.876819 0.018279 -0.696711 0.921252 -0.557368 -1.364299 -0.957743 -0.304960 -0.145045 -0.335677 -1.387642 1.920561 1.097830 -1.432839 0.759775 -0.364312 -2.356274 -0.496956 1.892579 1.250612 -1.001023 0.589322 0.355746 -0.778200 -0.095204 0.749072 -0.067315 1.796326 -0.937430 -0.754202 0.329508 -0.862288 -0.082528 0.407202 -0.100300 0.199445 -0.589606 0.122130 -0.020889 0.548083 0.689290 -0.166068 -1.013744 0.513763 -0.053227 -0.565191 0.040108 -0.428582 -0.852325 0.218163 -0.335456 -0.206735 -0.051834 -0.948498 -0.694292 0.975101 0.869625 1.295017 -1.167689 -0.250579 0.751483 -0.114711 -2.081837 -0.417782 -1.927254 1.323153 0.682058 -0.518307 1.145725 -0.377413 -0.398710 -0.158868 0.991756 1.092631 -0.466019 1.886947 0.219753 -1.488249 0.808739 -0.058949 -1.044924 -0.869188 0.670991 -0.132557 0.228496 0.070151 0.678435 0.368916 -1.607777 1.276882 -0.527794 -0.484907 1.551396 -0.301506 -0.165524 0.802906 -0.173875 1.085678 0.403394 -0.737697 1.416168 1.390040 -0.784257 -1.456984 -0.070360 0.726195 0.878690 -0.987598 -1.655020 -0.454624 -0.583411 -1.270046 -1.417367 -0.332897 -0.606878 1.710223 -1.100246 -0.008845 0.512202 -1.924728 -0.954283 1.241028 0.152001 -0.322439 -1.417710 1.260037 -0.279949 0.914000 -0.910598 0.691773 0.537397 -1.050138 1.096083 0.758983 0.400286 -0.673576 0.771543 1.113316 0.469877 0.250875 1.206190 -0.861483 0.886413 1.391424 1.479585 1.825262 0.117978 -0.506114 -1.500614 -1.155527 -0.026918 -1.094554 -1.162488 -0.085553 0.602640 0.895569 0.198097 0.411492 0.310599 0.705082 0.217833 0.368042 -2.189446 -0.867064 -1.501867 0.511160 0.477452 0.141908 -0.801737 0.647170 0.695376 1.326990 -0.001168 -0.790197 -1.047975 -1.004177 -0.749662 -0.495001 -0.430699 -0.938209 -0.421050 0.142913 -1.171509 2.485436 -1.730104 2.552633 -0.530820 0.220880 -1.781251 -0.642823 1.521469 -1.577009 0.012622 0.760484 -0.113812 -1.038649 0.661489 1.604851 0.275655 -0.067830 0.820340 0.425180 -1.211370 -1.048169 1.696336 -0.850019 2.023421 0.728760 -0.594656 0.075849 -1.021726 -0.353226 -1.300230 1.268835 -0.270475 -0.851679 -0.897806 -0.840004 0.279439 0.115099 0.480876 1.229935 1.800577 -0.302737 0.884317 1.782107 -1.345847 0.768262 -0.039708 -0.172451 -0.222770 -0.015482 -0.074949 -0.197910 0.386767 -0.512270 -0.310946 0.641344 -1.085523 1.348613 -1.284978 -0.170815 0.136810 0.888194 -0.094553 0.428437 -0.013875 -1.960770 1.057084 1.278702 0.761184 -0.812263 0.144695 -0.007552 -0.778043 0.874274 -0.115657 0.738675 0.468461 -0.570562 -0.991137 1.080222 -1.999556 -0.858536 -0.981598 0.415953 -1.001629 0.646236 0.710583 -0.552218 -0.127133 -0.710127 0.545803 -1.018406 -1.352418 -1.936412 -0.715130 0.701782 2.002463 -1.188552 0.004957 -0.271976 -0.388752 -1.564939 0.577630 0.588301 2.074679 0.584685 -0.168559 1.250694 -0.682807 -1.050154 1.687398 0.130365 0.291727 0.544375 -1.492861 -0.160861 -0.504564 1.643668 1.595091 -0.161683 0.293337 1.598750 -1.067107 0.397615 -1.482280 -1.073160 -0.227961 -0.572351 -0.722541 -1.149937 -0.397598 -1.108078 -2.330083 0.483827 -0.883305 -0.172650 -0.701459 1.721739 1.302382 -0.313849 -0.833192 0.497842 -2.115376 -0.754928 0.244905 -1.853823 -0.398978 0.220368 -0.579498 2.081822 -2.430426 -0.631533 -1.971937 -0.660585 -0.831499 0.252558 -0.041550 1.719289 0.954370 0.623598 0.239994 0.531440 -1.168545 0.674013 0.309943 0.054460 -1.024314 -0.544048 -0.364239 -0.692307 -0.182998 0.697960 1.323090 -0.170865 -0.491201 0.213726 -1.235531 -0.908442 -1.596012 0.862726 -1.784180 -1.471168 0.677965 -0.214122 -1.197300 -1.299616 1.867467 -1.506334 -0.127695 -0.747923 0.159552 -0.534041 1.054436 -0.276325 -0.254999 -0.634508 -0.243197 -2.230963 0.624365 1.113531 -1.214471 -0.749406 0.777103 -1.394246 0.124926 1.973244 -2.235203 -0.477218 -0.061790 0.209961 0.872764 -0.050682 0.637479 -0.701152 0.562655 -0.336065 0.353218 0.277213 2.018029 0.307320 -0.857235 -1.154324 -0.091842 -0.692366 -0.101415 -0.631387 -0.447558 0.032136 -0.833536 -0.723329 -1.005379 0.632533 0.075066 -0.124452 0.231981 0.177435 0.131491 -0.982521 -0.010304 2.340384 0.595947 1.238135 0.009757 0.525399 0.615883 -0.580781 -1.206288 1.029879 -0.286954 0.406926 -0.011277 1.523503 0.139378 1.177063 -1.962713 -0.113127 -0.597874 0.460950 1.069974 -1.794326 0.072526 -0.744506 1.111692 -0.863435 -1.310383 0.572158 1.745779 0.182827 -0.120991 2.025952 0.751498 0.726075 -1.542414 0.270124 1.164985 -1.642591 0.811889 2.374582 -0.619184 -1.053421 -0.181543 -1.002197 -0.117857 0.510987 -0.318559 -0.604074 0.765202 1.411966 -0.243556 0.446281 1.444896 1.267804 -2.234797 0.083544 -1.812455 -0.481718 0.467303 0.709694 -0.544356 1.596364 -2.508448 -0.467096 -1.097063 -0.015227 -0.464544 0.622737 0.903069 -0.674018 1.024780 -0.040688 -0.688681 -1.482484 0.341436 0.685062 -0.906655 1.111746 -1.324963 -0.502301 -0.231172 1.183053 1.052672 -0.006128 0.388500 -1.249388 -0.728359 -0.174126 -0.038694 -0.475047 -2.090355 0.031077 1.740928 -0.523460 -0.182126 -0.261719 0.589058 1.622314 0.335745 -0.441498 1.584948 -1.835192 -0.407950 -0.511660 -0.085760 -1.657893 0.488901 0.451632 -0.180217 0.442323 0.885002 -0.940964 -1.067690 0.683741 0.530086 0.861675 -0.163407 -0.481425 -0.128239 -0.975136 -0.192250 0.226960 1.131998 -0.473438 1.067205 0.918542 1.537711 -0.037092 -0.487446 -1.712450 -0.923055 -0.745595 -0.284515 0.401109 -0.214021 0.966810 -0.360553 -0.608100 -0.736673 0.117209 -0.910730 1.287569 -0.518275 -1.841172 0.110035 -2.672664 -0.002502 1.935803 2.700095 2.492495 -0.838827 -0.287432 -0.812173 1.333983 0.647154 0.225427 0.022249 -0.815657 -0.425117 -0.603234 0.251816 -1.766142 0.119322 -0.938448 -1.601751 -0.362955 -1.739450 -1.523959 -1.790699 -0.543262 0.648577 -1.900492 -0.342277 -0.121177 -0.833758 -0.001059 -1.031715 0.584437 -0.584703 0.589139 0.043770 0.809888 0.334586 0.890921 -0.717998 1.493110 -1.678664 -0.695589 -0.325866 -2.083260 -0.222828 -0.461387 -0.383187 -1.007315 2.580971 1.571833 0.427130 2.151779 -0.136369 2.322452 -1.643982 -0.042228 -0.442583 0.993938 -0.452280 -0.935096 -2.489647 0.021239 -1.718672 1.595024 -1.022730 -0.259247 1.448493 0.263395 0.335778 0.571265 -0.652513 1.878129 0.233618 -0.528888 -0.996440 -1.481054 -0.084978 1.478601 -0.610069 1.574585 0.095471 0.604786 -1.086510 0.375829 -1.230109 -1.085213 0.468261 -0.132709 -0.007395 -0.092810 -0.328420 -0.389345 1.014103 0.508600 -0.739737 0.613928 0.426653 0.417122 0.702983 0.683086 -1.176363 -0.364801 -0.885709 -0.316343 1.310882 -1.518462 1.281310 -0.166223 -0.344134 -0.274578 0.714641 1.052400 -0.496460 1.649288 -0.675791 1.885063 2.354965 -0.269205 -0.878682 0.945071 -0.575175 -0.281307 -1.691464 0.727663 -1.754825 0.380107 0.932610 0.916755 -0.697564 -0.486399 2.048525 0.577337 0.195165 -0.508344 0.304288 0.190245 0.885423\n"};
char *rtas[MAX_DESAFIOS] = {"entendido\n", "itba\n", "M4GFKZ289aku\n", "fk3wfLCm3QvS\n", "too_easy\n", ".RUN_ME\n", "K5n2UFfpFMUN\n", "BUmyYq5XxXGt\n", "u^v\n", "\n", "chin_chu_lan_cha\n", "gdb_rules\n", "normal\n"};

#define PORT 8080

void filter_error()
{
    char *rta = "K5n2UFfpFMUN";
    int i = 0;
    while (rta[i] != 0)
    {
        int randomfd = (rand() % 5) + 1;

        if (randomfd == STDOUT_FILENO)
        {
            write(STDOUT_FILENO, rta + i++, 1);
        }

        else
        {
            char c = (char)(rand() % (FIRST_ASCII - LAST_ASCII) + FIRST_ASCII);
            write(STDERR_FILENO, &c, 1);
        }
    }
}

void cleanBuffer(char *buffer)
{
    int i;
    for (i = 0; i < BUFF_SIZE || buffer[i] == 0; i++)
    {
        buffer[i] = 0;
    }
}

int main(int argc, char const *argv[])
{
    int server_fd, new_socket, valread;
    struct sockaddr_in address;
    int opt = 1;
    int addrlen = sizeof(address);
    char bufferClient[BUFF_SIZE] = {0};
    int desafioNro = 0;
    //////////////////////////// CREACION DEL SERVER ////////////////////////
    // Creating socket file descriptor
    if ((server_fd = socket(AF_INET, SOCK_STREAM, 0)) == 0)
    {
        perror("socket failed");
        exit(EXIT_FAILURE);
    }

    // Forcefully attaching socket to the port 8080
    if (setsockopt(server_fd, SOL_SOCKET, SO_REUSEADDR | SO_REUSEPORT,
                   &opt, sizeof(opt)))
    {
        perror("setsockopt");
        exit(EXIT_FAILURE);
    }
    address.sin_family = AF_INET;
    address.sin_addr.s_addr = INADDR_ANY;
    address.sin_port = htons(PORT);

    // Forcefully attaching socket to the port 8080
    if (bind(server_fd, (struct sockaddr *)&address,
             sizeof(address)) < 0)
    {
        perror("bind failed");
        exit(EXIT_FAILURE);
    }
    if (listen(server_fd, 3) < 0)
    {
        perror("listen");
        exit(EXIT_FAILURE);
    }

    ///////////////////////////////////////////////////////////////

    while ((new_socket = accept(server_fd, (struct sockaddr *)&address, (socklen_t *)&addrlen)))
    {
        printf(pistas[desafioNro]);
        while (desafioNro < MAX_DESAFIOS && (valread = read(new_socket, bufferClient, BUFF_SIZE)) > 0)
        {

            if (strcmp(bufferClient, rtas[desafioNro]) == 0)
            {
                desafioNro++;
            }
            else
            {
                printf("Respuesta incorrecta: %s", bufferClient);
            }
            cleanBuffer(bufferClient);
            sleep(1);
            system("clear");
            printf("-------DESAFIO NRO %d --------\n", desafioNro + 1);
            printf(pistas[desafioNro]);

            switch (desafioNro)
            {
            case 3:
                if (write(73, ".......................La respuesta es fk3wfLCm3QvS\n", 53) == -1)
                    perror("write");
                break;
            case 6:
                filter_error();
                break;
            default:
                break;
            }
        }

        if (new_socket < 0)
        {
            perror("accept");
            exit(EXIT_FAILURE);
        }
        if (valread < 0)
        {
            perror("error in fd reading");
            exit(EXIT_FAILURE);
        }
    }
    printf("Felicitaciones, finalizaron el juego. Ahora deberán implementar el servidor que se comporte como el servidor provisto\n");
    close(server_fd);
    //chequear error del close
    return 0;
}